# OpenManus 项目架构

## 技术栈

- Python 3.11+
- asyncio（异步编程）
- Pydantic（数据验证和模型）
- loguru（日志记录）
- Conda 环境管理（环境名：open_manus）

## 目录结构

```
OpenManus/
├── app/                              # 核心应用代码
│   ├── agent/                        # 智能体模块
│   │   ├── base.py                  # 智能体基类，提供状态管理、记忆管理、执行循环
│   │   ├── react.py                 # ReAct 模式实现（思考-行动-观察循环）
│   │   ├── toolcall.py              # 工具调用智能体基类，处理工具选择和执行
│   │   ├── manus.py                 # Manus 主智能体，支持本地工具和 MCP 工具
│   │   ├── browser.py               # 浏览器上下文助手，管理浏览器状态
│   │   ├── data_analysis.py         # 数据分析智能体
│   │   ├── swe.py                   # 软件工程智能体（代码生成、调试等）
│   │   ├── sandbox_agent.py         # 沙箱智能体，使用 Daytona 云沙箱
│   │   └── mcp.py                   # MCP 协议智能体
│   │
│   ├── flow/                        # 多智能体流程控制
│   │   ├── base.py                  # 流程基类，定义流程执行框架
│   │   ├── planning.py              # 规划流程，协调多个智能体完成任务
│   │   └── flow_factory.py         # 流程工厂，创建不同类型的流程实例
│   │
│   ├── tool/                        # 工具集模块
│   │   ├── base.py                  # 工具基类，定义工具接口和结果格式
│   │   ├── tool_collection.py       # 工具集合管理，工具注册和查找
│   │   ├── python_execute.py        # Python 代码执行工具
│   │   ├── browser_use_tool.py      # 浏览器自动化工具（导航、点击、输入等）
│   │   ├── str_replace_editor.py    # 文本文件编辑工具（查看、创建、编辑）
│   │   ├── web_search.py            # 网络搜索工具（统一搜索接口）
│   │   ├── search/                  # 搜索引擎实现
│   │   │   ├── google_search.py     # Google 搜索
│   │   │   ├── baidu_search.py      # 百度搜索
│   │   │   ├── bing_search.py       # Bing 搜索
│   │   │   └── duckduckgo_search.py # DuckDuckGo 搜索
│   │   ├── sandbox/                 # 沙箱工具（基于 Daytona）
│   │   │   ├── sb_browser_tool.py   # 沙箱浏览器工具（VNC 可视化）
│   │   │   ├── sb_shell_tool.py     # 沙箱终端工具
│   │   │   ├── sb_files_tool.py     # 沙箱文件操作工具
│   │   │   └── sb_vision_tool.py    # 沙箱视觉工具（截图等）
│   │   ├── chart_visualization/     # 数据可视化工具
│   │   │   └── data_visualization.py # 图表生成和可视化
│   │   ├── mcp.py                   # MCP 客户端工具，连接远程 MCP 服务器
│   │   ├── ask_human.py             # 询问人类工具，支持人机交互
│   │   ├── terminate.py             # 终止工具，结束智能体执行
│   │   └── file_operators.py        # 文件操作工具（本地和沙箱）
│   │
│   ├── prompt/                      # 提示词模板模块
│   │   ├── manus.py                 # Manus 智能体的系统提示词
│   │   ├── toolcall.py              # 工具调用提示词
│   │   ├── browser.py               # 浏览器操作提示词
│   │   ├── planning.py              # 规划流程提示词
│   │   ├── swe.py                   # 软件工程提示词
│   │   ├── mcp.py                   # MCP 协议提示词
│   │   └── visualization.py         # 数据可视化提示词
│   │
│   ├── daytona/                     # Daytona 云沙箱集成
│   │   ├── sandbox.py               # 沙箱管理（创建、启动、删除）
│   │   └── tool_base.py             # 沙箱工具基类
│   │
│   ├── sandbox/                     # 本地沙箱模块
│   │   ├── client.py                # 沙箱客户端
│   │   └── core/                    # 沙箱核心功能
│   │       ├── manager.py           # 沙箱管理器
│   │       ├── sandbox.py           # 沙箱实现
│   │       └── terminal.py          # 终端执行
│   │
│   ├── mcp/                         # MCP（Model Context Protocol）模块
│   │   └── server.py                # MCP 服务器实现
│   │
│   ├── jobs/                        # 远程工作扫描器模块
│   │   ├── models.py                # 数据模型（配置、工作信息）
│   │   ├── config_loader.py        # 配置加载器
│   │   ├── base_scraper.py         # 爬虫基类
│   │   ├── scrapers.py             # 各网站爬虫实现（Remotive、WWR、RemoteOK 等）
│   │   ├── telegram_service.py     # Telegram 推送服务
│   │   ├── storage.py              # 存储管理（去重）
│   │   ├── scanner.py              # 扫描器主类
│   │   └── scheduler.py            # 任务调度器（定时扫描）
│   │
│   ├── utils/                       # 工具函数模块
│   │   ├── files_utils.py          # 文件操作工具函数
│   │   └── logger.py                # 日志工具
│   │
│   ├── llm.py                       # LLM 接口封装
│   │                                # - 支持 OpenAI、Azure、Ollama、Bedrock 等
│   │                                # - Token 计数和管理
│   │                                # - 流式和非流式响应
│   │                                # - 工具调用（Function Calling）
│   │                                # - 多模态输入（图片）
│   │
│   ├── config.py                    # 配置管理模块
│   │                                # - 加载 TOML 配置文件
│   │                                # - LLM、浏览器、搜索、MCP 等配置
│   │                                # - 单例模式，全局配置访问
│   │
│   ├── schema.py                    # 数据模型定义
│   │                                # - Message、Memory、ToolCall 等
│   │                                # - AgentState、Role、ToolChoice 枚举
│   │
│   ├── logger.py                    # 日志配置
│   ├── bedrock.py                   # AWS Bedrock 客户端
│   └── exceptions.py                # 自定义异常类
│
├── protocol/                        # 协议集成模块
│   └── a2a/                         # A2A（Agent-to-Agent）协议集成
│       └── app/                     # A2A 服务器实现
│           ├── main.py              # A2A 服务器启动入口
│           ├── agent.py             # A2AManus 类，A2A 协议适配
│           └── agent_executor.py   # A2A 请求执行器
│
├── config/                          # 配置文件目录
│   ├── config.toml                  # 主配置文件（需自行创建）
│   ├── config.example.toml          # 配置示例文件
│   ├── config.example-daytona.toml  # Daytona 配置示例
│   └── mcp.json                     # MCP 服务器配置（可选）
│
├── workspace/                       # 工作空间目录
│   └── [生成的文件和项目]              # 智能体生成的文件存放于此
│
├── logs/                           # 日志文件目录
│   └── [日期].log                   # 按日期记录的日志文件
│
├── main.py                         # 单智能体启动入口
│                                  # - 创建 Manus 智能体
│                                  # - 执行用户任务
│                                  # - 支持命令行参数和交互式输入
│
├── run_flow.py                     # 多智能体流程启动入口
│                                  # - 启动规划流程
│                                  # - 协调多个智能体协作
│
├── run_mcp.py                      # MCP 工具服务启动入口
│                                  # - 启动 MCP 服务器
│                                  # - 提供工具服务
│
└── sandbox_main.py                 # 沙箱智能体启动入口
                                  # - 使用 Daytona 云沙箱
                                  # - 支持可视化调试
```

## 核心组件

### 智能体（Agent）

智能体是 OpenManus 的核心，负责理解任务、选择工具、执行操作。

- **BaseAgent** (`app/agent/base.py`)：所有智能体的基类
  - 提供状态管理、记忆管理、执行循环等核心功能
  - 管理对话历史和上下文

- **ToolCallAgent** (`app/agent/toolcall.py`)：工具调用智能体基类
  - 处理工具选择、参数准备、执行和结果处理
  - 支持工具调用的完整生命周期

- **Manus** (`app/agent/manus.py`)：主智能体
  - 集成本地工具和 MCP 工具
  - 支持浏览器上下文感知
  - 自动管理工具执行流程

- **ReAct** (`app/agent/react.py`)：ReAct 模式实现
  - 思考（Think）- 行动（Act）- 观察（Observe）循环
  - 最多执行 20 步，自动判断任务完成

### 工具（Tool）

工具是智能体执行具体操作的接口。

- **BaseTool** (`app/tool/base.py`)：工具基类
  - 定义工具接口和结果格式
  - 所有工具必须继承此类

- **ToolCollection** (`app/tool/tool_collection.py`)：工具集合管理
  - 工具注册和查找
  - 自动发现和加载工具

- **本地工具**：
  - `python_execute.py`：Python 代码执行
  - `browser_use_tool.py`：浏览器自动化
  - `str_replace_editor.py`：文件编辑
  - `web_search.py`：网络搜索

- **沙箱工具**（基于 Daytona）：
  - `sb_browser_tool.py`：沙箱浏览器（VNC 可视化）
  - `sb_shell_tool.py`：沙箱终端
  - `sb_files_tool.py`：沙箱文件操作

- **MCP 工具** (`app/tool/mcp.py`)：
  - 连接远程 MCP 服务器
  - 自动发现和注册远程工具

### 多智能体流程（Flow）

支持多个智能体协作完成复杂任务。

- **BaseFlow** (`app/flow/base.py`)：流程基类
  - 定义流程执行框架
  - 管理多个智能体的协调

- **PlanningFlow** (`app/flow/planning.py`)：规划流程
  - 将复杂任务分解为子任务
  - 协调多个智能体协作完成

### LLM 接口 (`app/llm.py`)

统一的 LLM 接口封装，支持多种提供商：

- OpenAI（GPT-4、GPT-3.5 等）
- Azure OpenAI
- Ollama（本地模型）
- AWS Bedrock
- 支持流式和非流式响应
- Token 计数和限制管理
- 工具调用（Function Calling）
- 多模态输入（图片）

### 配置管理 (`app/config.py`)

- 单例模式，全局配置访问
- 支持多 LLM 配置
- 自动加载 TOML 配置文件
- 支持环境变量覆盖

## 扩展模块

### Daytona 云沙箱 (`app/daytona/`)

- 创建和管理云沙箱环境
- 支持 VNC 远程访问和可视化调试
- 隔离的执行环境

### MCP 协议支持 (`app/mcp/`)

- 实现 MCP 服务器，提供工具服务
- 支持 SSE 和 stdio 两种连接方式
- 可连接远程 MCP 服务器

### A2A 协议集成 (`protocol/a2a/`)

- 将 OpenManus 智能体暴露为 A2A 标准服务
- 支持其他 A2A 客户端调用
- 标准化的智能体通信协议

## 辅助模块

### 提示词模板 (`app/prompt/`)

- 各智能体的系统提示词和下一步提示词
- 支持动态格式化（工作空间路径等）
- 可自定义和扩展

### 工具函数 (`app/utils/`)

- 文件操作、路径处理
- 日志记录工具

### 数据模型 (`app/schema.py`)

- 定义消息、记忆、工具调用等核心数据结构
- 使用 Pydantic 进行数据验证
