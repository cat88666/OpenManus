# OpenManus 快速开始

## 快速开始

### 安装步骤

**1. 创建 Conda 环境**
```bash
conda create -n open_manus python=3.11 -y
conda activate open_manus
```

**2. 安装依赖**
```bash
pip install -r requirements.txt
playwright install
```

**3. 配置 API**
编辑 `config/config.toml` 文件，配置您的 API 密钥。

**4. 验证安装**
```bash
python main.py --prompt "请说 Hello World"
```

## 启动方式

### 方式一：单智能体模式（推荐）

**命令行参数方式**
```bash
conda activate open_manus
python main.py --prompt "你的任务描述"
```

**交互式输入方式**
```bash
conda activate open_manus
python main.py  # 然后根据提示输入您的需求
```

### 方式二：多智能体流程

```bash
python run_flow.py
```

用于需要多个智能体协作完成的复杂任务。

### 方式三：MCP 工具服务

```bash
python run_mcp.py
```

启动 MCP 服务器，提供工具服务。

### 方式四：沙箱智能体

```bash
python sandbox_main.py
```

使用 Daytona 云沙箱，支持可视化调试。

## 执行流程详解

运行 `python main.py --prompt "你的提示"` 时，系统按以下详细流程执行：

### 1. 程序启动阶段

```
__main__:main → 解析命令行参数 → 创建 Manus 智能体实例
```

- 解析命令行参数（`--prompt` 或交互式输入）
- 创建 Manus 智能体实例

### 2. 智能体初始化阶段

- **加载配置文件** (`config/config.toml`)
  - LLM 配置（API Key、模型等）
  - 浏览器配置
  - 搜索配置
  - MCP 服务器配置

- **初始化工具集合**
  - 文件操作工具（查看、创建、编辑）
  - 浏览器控制工具（导航、点击、输入等）
  - Python 执行工具
  - 网络搜索工具（Google、Baidu、Bing 等）
  - MCP 工具（如果配置了）

- **连接 MCP 服务器**（如果配置了）
  - 建立连接
  - 发现远程工具
  - 注册到工具集合

- **设置系统提示词和工作空间路径**
  - 加载提示词模板
  - 设置工作空间路径（`workspace/`）

### 3. 任务执行循环（ReAct 模式，最多 20 步）

每个步骤包含以下子流程：

#### 3.1 思考阶段 (Think)

```
app.agent.toolcall:think → LLM 分析当前状态 → 生成思考内容
```

- **分析用户需求和当前上下文**
  - 理解用户意图
  - 分析当前任务状态
  - 评估已完成的工作

- **决定下一步行动**
  - 判断任务是否完成
  - 选择需要执行的操作
  - 规划执行步骤

- **选择需要使用的工具**
  - 从可用工具中选择合适的工具
  - 评估工具的能力和适用性

#### 3.2 工具选择阶段

```
app.agent.toolcall:think → 选择工具 → 准备工具参数
```

- **根据任务需求选择合适工具**
  - 文件操作：使用 `str_replace_editor`
  - 网络搜索：使用 `web_search`
  - 浏览器操作：使用 `browser_use`
  - 代码执行：使用 `python_execute`

- **准备工具执行所需的参数**
  - 根据工具定义准备参数
  - 验证参数格式和有效性

- **记录 Token 使用情况**
  - 输入 Token 数
  - 输出 Token 数
  - 累计 Token 使用

#### 3.3 工具执行阶段 (Act)

```
app.agent.toolcall:execute_tool → 工具执行 → 获取结果
```

- **激活选定的工具**
  - 调用工具的 `execute()` 方法
  - 传入准备好的参数

- **执行具体操作**
  - **文件操作**：查看、创建、编辑文件
  - **网络搜索**：搜索信息，返回结果
  - **浏览器操作**：导航、点击、输入、提取内容
  - **代码执行**：在子进程中执行 Python 代码
  - **MCP 工具**：调用远程工具服务

- **捕获工具执行结果**
  - 成功：返回执行结果
  - 失败：返回错误信息

#### 3.4 观察阶段 (Observe)

```
app.agent.toolcall:act → 处理工具结果 → 更新上下文
```

- **处理工具返回的结果**
  - 解析结果格式
  - 提取关键信息

- **将结果添加到对话历史**
  - 记录工具调用
  - 记录执行结果
  - 更新上下文状态

- **为下一步决策提供上下文**
  - 将结果传递给 LLM
  - 更新任务状态

#### 3.5 循环判断

- **如果任务完成** → 调用 `terminate` 工具退出
- **如果未完成且未达到最大步数** → 继续下一步
- **如果达到最大步数（20步）** → 自动退出

### 4. 工具类型示例

根据日志分析，常用工具执行流程：

#### 浏览器工具 (browser_use)

```
web_search → 尝试 Google → 尝试 Baidu → 返回搜索结果
go_to_url → 导航到指定网页
click_element → 点击页面元素
extract_content → 提取页面内容
scroll_down → 滚动页面
```

#### 文件操作工具 (str_replace_editor)

```
view → 查看文件/目录
create → 创建新文件
edit → 编辑文件内容
```

#### Python 执行工具 (python_execute)

```
接收代码 → 在子进程中执行 → 返回输出结果
```

### 5. 错误处理机制

- **工具执行失败时**
  - 记录错误日志
  - 返回错误信息给智能体

- **智能体自动尝试替代方案**
  - 分析错误原因
  - 选择替代工具或方法
  - 继续执行下一步

- **不会因单个工具失败而中断**
  - 记录错误但继续执行
  - 尝试其他方法完成任务

### 6. 资源清理阶段

```
app.tool.mcp:disconnect → 断开 MCP 连接
app.agent.cleanup → 清理浏览器上下文
__main__:main → 请求处理完成
```

- **断开 MCP 连接**
  - 关闭所有 MCP 服务器连接
  - 清理连接资源

- **清理浏览器上下文**
  - 关闭浏览器实例
  - 清理临时文件

- **完成请求处理**
  - 输出最终结果
  - 退出程序

### 7. 日志记录

每个步骤的详细信息都会记录到日志文件：

- **时间戳**：记录操作时间
- **日志级别**：INFO/WARNING/ERROR
- **模块和函数位置**：定位代码位置
- **执行内容**：详细的操作信息
- **Token 使用统计**：输入/输出/累计 Token 数

日志文件保存在 `logs/` 目录，按日期命名。

## 使用示例

### 示例 1：文件操作

```bash
python main.py --prompt "创建一个 hello.py 文件，内容为 print('Hello World')"
```

智能体会：
1. 分析任务：需要创建文件
2. 选择工具：`str_replace_editor`
3. 执行操作：创建 `workspace/hello.py`
4. 完成任务

### 示例 2：网络搜索

```bash
python main.py --prompt "搜索 Python 异步编程的最佳实践"
```

智能体会：
1. 分析任务：需要搜索信息
2. 选择工具：`web_search`
3. 执行操作：搜索并返回结果
4. 完成任务

### 示例 3：浏览器操作

```bash
python main.py --prompt "访问 GitHub，搜索 OpenManus 项目"
```

智能体会：
1. 分析任务：需要浏览器操作
2. 选择工具：`browser_use`
3. 执行操作：导航到 GitHub，搜索项目
4. 提取结果并返回
5. 完成任务

### 示例 4：代码执行

```bash
python main.py --prompt "计算 1 到 100 的和"
```

智能体会：
1. 分析任务：需要执行计算
2. 选择工具：`python_execute`
3. 执行操作：执行 Python 代码计算
4. 返回结果
5. 完成任务

## 配置说明

### 配置文件位置

主配置文件：`config/config.toml`

### 主要配置项

- **LLM 配置**：API Key、模型、温度等
- **浏览器配置**：浏览器类型、超时时间等
- **搜索配置**：搜索引擎选择、重试次数等
- **MCP 配置**：MCP 服务器连接信息

详细配置说明请参考 `config/config.example.toml`。

## 工作空间

- **生成的文件保存在 `workspace/` 目录**
- **日志文件保存在 `logs/` 目录**
- **不要将生成的文件提交到版本控制**

## 常见问题

### Q: 如何查看执行日志？

A: 日志文件保存在 `logs/` 目录，按日期命名。可以使用文本编辑器打开查看。

### Q: 如何增加最大执行步数？

A: 修改 `app/agent/react.py` 中的 `MAX_STEPS` 常量。

### Q: 如何添加自定义工具？

A: 参考 [开发规范](04-开发规范.md) 中的"添加新工具"部分。

### Q: 如何配置 MCP 服务器？

A: 编辑 `config/mcp.json` 文件，添加 MCP 服务器配置。

